<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, shrink-to-fit=no"
    />
    <title>Ultraviolet</title>
    <meta
      name="description"
      content="Ultraviolet is a highly sophisticated proxy used for evading internet censorship or accessing websites in a controlled sandbox using the power of service-workers. Unblock sites today!"
    />
    <meta
      name="keywords"
      content="proxy, web proxy, ultraviolet, service workers, unblock websites, unblock chromebook, free web proxy, proxy list, proxy sites, un block chromebook, online proxy, proxy server, proxysite, proxy youtube, bypass securly, bypass iboss, bypass lightspeed filter, holy unblocker, chromebooks, titanium network, unblock youtube, youtube proxy, unblocked youtube, youtube unblocked"
    />
    <meta
      name="theme-color"
      media="(prefers-color-scheme: dark)"
      content="#434c5e"
    />
    <meta name="googlebot" content="index, follow, snippet" />
    <link rel="shortcut icon" content="favicon.ico" />
    <link rel="stylesheet" href="index.css" />
    <!-- Important: deviceId.js and verify.js placed at the top without defer -->
    <script src="js/deviceId.js"></script>
    <script src="js/verify.js"></script>
    <!-- Early initialization script to ensure proper functioning of the page -->
    <script>
      // Improved function to check if the page is in an about:blank iframe
      function isInAboutBlank() {
        try {
          // Check URL parameter first (most reliable)
          const urlParams = new URLSearchParams(window.location.search);
          if (urlParams.get('skipAB') === 'true') {
            return true;
          }
          
          // Check sessionStorage
          if (sessionStorage.getItem('inAboutBlank') === 'true') {
            return true;
          }
          
          // Check if we're in an iframe
          if (window.self !== window.top) {
            try {
              // Attempt to access parent location - will fail if cross-origin
              const parentUrl = window.parent.location.href;
              return parentUrl.startsWith('about:blank');
            } catch (e) {
              // If error accessing parent, check referrer as fallback
              return document.referrer === '' && window.location.href !== window.location.origin + '/';
            }
          }
          return false;
        } catch (e) {
          console.error("Error in isInAboutBlank:", e);
          // Default to false on error
          return false;
        }
      }

      // Function to open the current page in about:blank
      function openInAboutBlank() {
        try {
          // Set flag in sessionStorage
          sessionStorage.setItem('inAboutBlank', 'true');
          
          // Open about:blank window
          const win = window.open('about:blank', '_blank');
          if (win) {
            // Get current URL and add skipAB parameter
            let currentUrl = window.location.href;
            const urlObj = new URL(currentUrl);
            urlObj.searchParams.set('skipAB', 'true');
            currentUrl = urlObj.toString();
            
            // Write to the new document
            win.document.write(`
              <!DOCTYPE html>
              <html>
                <head>
                  <title>Ultraviolet</title>
                  <style>
                    body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; }
                    iframe { width: 100%; height: 100%; border: none; }
                  </style>
                  <script>
                    // Set sessionStorage in the new window
                    try {
                      sessionStorage.setItem('inAboutBlank', 'true');
                    } catch(e) {
                      console.warn("Could not set sessionStorage flag", e);
                    }
                  <\/script>
                </head>
                <body>
                  <iframe src="${currentUrl}"></iframe>
                </body>
              </html>
            `);
            win.document.close(); // Close the document for writing
          } else {
            alert('Popup blocked. Please allow popups for this site to continue.');
          }
        } catch (e) {
          console.error("Error in openInAboutBlank:", e);
          alert('An error occurred when opening about:blank. Please try again.');
        }
      }

      // Main initialization function with proper error handling
      function initializePage() {
        try {
          const inAboutBlank = isInAboutBlank();
          console.log("In about:blank iframe detection:", inAboutBlank);

          if (inAboutBlank) {
            // In about:blank iframe, show content
            document.body.classList.remove('content-hidden');
            const popupElement = document.getElementById('aboutBlankPopup');
            if (popupElement) {
              popupElement.style.display = 'none';
            }
            
            // Store state
            try {
              sessionStorage.setItem('inAboutBlank', 'true');
            } catch (e) {
              console.warn("Could not set sessionStorage flag", e);
            }
          } else {
            // Show about:blank popup
            document.body.classList.add('content-hidden');
            const popupElement = document.getElementById('aboutBlankPopup');
            if (popupElement) {
              popupElement.style.display = 'flex';
            }
          }
          
          // Apply dark mode if needed
          if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add('dark-mode');
          }
        } catch (e) {
          console.error("Error in initializePage:", e);
          // Show content as fallback on error
          document.body.classList.remove('content-hidden');
        }
      }

      // Ensure scripts are executed in the correct order
      // Execute immediately - no waiting for DOM
      (function() {
        try {
          // Check if we need to immediately remove content-hidden
          if (isInAboutBlank()) {
            // If we're already in about:blank, ensure body isn't hidden when possible
            if (document.body) {
              document.body.classList.remove('content-hidden');
            }
          }
        } catch (e) {
          console.error("Error in immediate check:", e);
        }
      })();

      // Multiple event handlers to ensure initialization happens
      document.addEventListener('DOMContentLoaded', initializePage);
      window.addEventListener('load', function() {
        // Check if already initialized
        if (document.body.classList.contains('content-hidden') && 
            document.getElementById('aboutBlankPopup') && 
            isInAboutBlank()) {
          initializePage();
        }
      });
    </script>
    <!-- Other scripts can be deferred -->
    <script src="baremux/index.js" defer></script>
    <script src="epoxy/index.js" defer></script>
    <script src="uv/uv.bundle.js" defer></script>
    <script src="uv/uv.config.js" defer></script>
    <script src="register-sw.js" defer></script>
    <script src="search.js" defer></script>
    <script src="index.js" defer></script>
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": [
          {
            "@type": "Question",
            "name": "What is Ultraviolet (Web Proxy)?",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "Highly sophisticated proxy used for evading internet censorship or accessing websites in a controlled sandbox using the power of service-workers and more!"
            }
          },
          {
            "@type": "Question",
            "name": "How do I unblock sites using Ultraviolet?",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "Simply head to an official site featuring Ultraviolet such as Holy Unblocker or Incognito! You can also self-host Ultraviolet on your own web server for maximum privacy."
            }
          },
          {
            "@type": "Question",
            "name": "What if Ultraviolet is blocked or not working?",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "Join the Titanium Network Discord at discord.gg/unblock!"
            }
          }
        ]
      }
    </script>
    <style>
      .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      
      .popup-content {
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
        max-width: 500px;
        width: 90%;
        text-align: center;
        position: relative;
      }
      
      .dark-mode .popup-content {
        background-color: #2E3440;
        color: #E5E9F0;
      }
      
      .popup-btn {
        display: inline-block;
        margin: 10px;
        padding: 8px 16px;
        background-color: #5E81AC;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
      }
      
      .popup-btn:hover {
        background-color: #81A1C1;
      }
      
      /* Hide the main content until the about:blank iframe is used */
      body.content-hidden > *:not(#aboutBlankPopup) {
        display: none !important;
      }
      
      body.content-hidden {
        background: #000;
      }
    </style>
  </head>

  <body class="content-hidden">
    <!-- About:Blank Popup -->
    <div id="aboutBlankPopup" class="popup-overlay">
      <div class="popup-content">
        <h2>Security Notice</h2>
        <p>For your privacy and security, this page must be opened in an about:blank iframe.</p>
        <p>Click the button below to continue:</p>
        <button class="popup-btn" onclick="openInAboutBlank()">Open in about:blank</button>
      </div>
    </div>

    <div
      title="Ultraviolet Logo"
      class="flex-center logo-wrapper header-center"
    >
      <img class="logo" src="uv.png" alt="Ultraviolet" />
      <h1>Ultraviolet | TN</h1>
    </div>
    <div class="flex-center desc left-margin">
      <p>
        Ultraviolet is highly sophisticated proxy used for evading internet
        censorship.
      </p>
    </div>

    <form id="uv-form" class="flex-center">
      <input
        id="uv-search-engine"
        value="https://www.google.com/search?q=%s"
        type="hidden"
      />
      <input id="uv-address" type="text" placeholder="Search the web freely" />
    </form>
    <div class="desc left-margin">
      <p id="uv-error"></p>
      <pre id="uv-error-code"></pre>
    </div>
    <footer>
      <div>
        <a
          title="The TitaniumNetwork GitHub organization"
          href="https://github.com/titaniumnetwork-dev"
          >TitaniumNetwork</a
        >
        <a title="The TitaniumNetwork Discord" href="https://discord.gg/unblock"
          >Discord</a
        >
        <a
          title="The TompHTTP GitHub organization"
          href="https://github.com/tomphttp"
          >TompHTTP</a
        >
        <a
          title="The official deployment repository for Ultraviolet"
          href="https://github.com/titaniumnetwork-dev/Ultraviolet-App"
          >GitHub</a
        >
        <a title="License information" href="credits.html">Credits</a>
      </div>
      <div>
        <span>Ultraviolet &copy; TN 2023</span>
      </div>
    </footer>
    <iframe style="display: none;" id="uv-frame"></iframe>
  </body>
</html>